<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <title>燐字領収書</title>
</head>

<body>
  <img src="receipt_example.png" />
  <br>
  <button onclick="generate_image()" style="font-size: 80px;">生成</button>
  <br>
  <canvas height="591" width="1181" style="border: 5px dashed blue; margin: 15px 0 10px 0" id="main_canvas"></canvas>
  <br>
  <button onclick="download_image()" style="font-size: 80px;">下載</button>
</body>
<script>
  /**************
   * 品目のリスト
   **************/
  const PRODUCTS = [
    { name: "机戦", price: 6000 },
    { name: "紙机戦", price: 1500 },
    { name: "軟学清字", price: 500 },
    { name: "我等之遊術", price: 1500 },
    { name: "極軟片遊", price: 2800 },
    { name: "行山", price: 2800 },
    { name: "裁六軸", price: 500 },
    { name: "斥銭", price: -500 },
  ];

  /*
   * 「サイズ」を基準とした方眼の上に字を書いていく。
   * 縦書きしたとき、一番右の行が行番号 0 となる。
   * 
   * 「開始位置」が指定されているならば、
   * 「行番号と開始位置が交差する位置」が、文字列全体を囲う枠の右上の角となるように文字を置いていく。
   * 
   * そうでなくて、「終了位置」が指定されているならば、
   * 「行番号と終了位置が交差する位置」が、文字列全体を囲う枠の右下の角となるように文字を置いていく。
   */
  const content = [
    { サイズ: 2, 行番号: 0, 開始位置: 0, 内容: "汝於言将机戦" },
    { サイズ: 2, 行番号: 2, 開始位置: 0, 内容: "人等与銭如此" },
    { サイズ: 2, 行番号: 4.8, 開始位置: 0, 内容: "机戦" }, { サイズ: 1, 行番号: 5.3, 終了位置: 12, 内容: "六十百" },
    { サイズ: 2, 行番号: 7.6, 開始位置: 0, 内容: "紙机戦" }, { サイズ: 1, 行番号: 8.1, 終了位置: 12, 内容: "十五百" },
    { サイズ: 2, 行番号: 10.4, 開始位置: 0, 内容: "軟学清字" }, { サイズ: 1, 行番号: 10.9, 終了位置: 12, 内容: "五百" },
    { サイズ: 2, 行番号: 13.2, 開始位置: 0, 内容: "斥銭" }, { サイズ: 1, 行番号: 13.7, 終了位置: 12, 内容: "五百" },
    { サイズ: 2, 行番号: 16, 開始位置: 0, 内容: "全" }, { サイズ: 1, 行番号: 16.5, 終了位置: 12, 内容: "七十百言将銭" },
    { サイズ: 1, 行番号: 18.6, 開始位置: 0, 内容: "十二月九日" },
    { サイズ: 2, 行番号: 20.2, 開始位置: 0, 内容: "如右" },
  ];

  function generate_image() {
    const canvas = document.getElementById("main_canvas");
    const ctx = canvas.getContext("2d");

    const MARGIN_RIGHT = 31;
    const MARGIN_TOP = 20;
    const SIZE_FACTOR = 91 / 2;

    //const sample_image = new Image(1181, 591);
    //sample_image.src = "receipt_example.png";
    //sample_image.onload = () => {
    // ctx.drawImage(sample_image, 0, 0);

    const LinzklarRounded = new FontFace('LinzklarRounded', 'url(https://yasusho.github.io/linmarn_font_project/fonts/rounded/linzklar_rounded.woff)');

    LinzklarRounded.load().then(function (font) {
      document.fonts.add(font);
      console.log('Font loaded');
      ctx.font = "91px LinzklarRounded";
      ctx.textAlign = "right";
      ctx.textBaseline = "top";

      content.forEach(o => {
        const font_size = o.サイズ * SIZE_FACTOR;
        ctx.font = `${font_size}px LinzklarRounded`;

        if (o.開始位置 != null && o.終了位置 != null) {
          alert("開始位置と終了位置を両方指定することはできません");
          throw new Error("開始位置と終了位置を両方指定することはできません");
        }

        const 開始位置 = o.開始位置 ?? o.終了位置 - o.サイズ * o.内容.length;

        [...o.内容].map((char, ind) => {
            ctx.fillText(
              char,
              1181 - MARGIN_RIGHT - SIZE_FACTOR * o.行番号,
              MARGIN_TOP + font_size * ind + SIZE_FACTOR * 開始位置
            );
        });
      });
    });
    //}
  }

  function download_image() {
    const canvas = document.getElementById("main_canvas");
    image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
    const link = document.createElement('a');
    link.download = "receipt.png";
    link.href = image;
    link.click();
    link.remove();
  }
</script>